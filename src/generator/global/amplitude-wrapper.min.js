(function () {
  // Ensure the namespace exists
  window.ShopsenseEmbeds = window.ShopsenseEmbeds || {};
  window.ShopsenseEmbeds.env = '{{ENV_PLACEHOLDER}}';

  window.ShopsenseEmbeds.getUtmParams = () => {
    const urlParams = new URLSearchParams(window.location.search);
    return {
      utm_source: urlParams.get('utm_source'),
      utm_medium: urlParams.get('utm_medium'),
      utm_campaign: urlParams.get('utm_campaign'),
      utm_term: urlParams.get('utm_term'),
      utm_content: urlParams.get('utm_content'),
    };
  };

  const initUtmParams = (utmParams) => {
    window.ShopsenseEmbeds.utmParams = utmParams || {};

    if (Object.values(window.ShopsenseEmbeds.utmParams).length) {
      // Create an Identify object and set UTM parameters
      const identify = new amplitude.Identify();
      for (const [key, value] of Object.entries(window.ShopsenseEmbeds.utmParams)) {
        if (value) {
          identify.set(key, value);
        }
      }

      // Send the Identify call to set user properties
      window.ShopsenseEmbeds.amplitude.identify(identify);
    }
  };

  const init = () => {
    window.ShopsenseEmbeds.amplitude = window.amplitude || {};

    // Initialize Amplitude with UTM parameters
    window.ShopsenseEmbeds.amplitude.init('{{AMPLITUDE_API_KEY}}', {
      // autocapture: { elementInteractions: true, attribution: true },
      autocapture: false,
      includeUtm: true,
      includeReferrer: true,
    });

    window.addEventListener('message', (event) => {
      initUtmParams(event.data);
    });

    initUtmParams(window.ShopsenseEmbeds.getUtmParams());
  };

  var events = {};
  const logEvent = (_n, t = {}) => {
    const n = `Ads - ${_n}`;
    const key = `${n}${JSON.stringify(t)}`;
    if (!events[key]) {
      events[key] = JSON.stringify(t);
      console.log(`Event: ${n}`, t);
      if (window.ShopsenseEmbeds.env === 'production') {
        window.ShopsenseEmbeds.amplitude.logEvent(n, t);
      }
    }
  };

  window.ShopsenseEmbeds.analytics = { logEvent: logEvent };

  document.addEventListener('DOMContentLoaded', init);
  document.addEventListener('ShopsenseEmbedInjected', init);
})();
